"# wechaty-robot-lite" 

### å‰è¨€

æœ€è¿‘åœ¨dyä¸Šçœ‹åˆ°æœ‰ç›¸å…³wxæœºå™¨äººï¼ˆSCRMï¼‰åœ¨è¿›è¡Œç›¸å…³æ¨å¹¿ï¼Œè€Œä¹‹å‰å­¦ä¹ çš„æ—¶å€™ï¼Œç”¨åŸºäºpythonå¼€å‘çš„itchatç©è¿‡ä¸€æ®µæ—¶é—´ï¼Œåæ¥ï¼ŒæŸä¸€å¤©çªç„¶å‘ç°å¾®ä¿¡ç™»ä¸ä¸Šäº†ï¼Œå®˜æ–¹çš„å¾®ä¿¡ç½‘é¡µç‰ˆä¹Ÿä¸èƒ½ç™»é™†äº†ï¼ˆè‡³äºæ˜¯å•¥åŸå› ï¼Œå’±ä¹Ÿä¸çŸ¥é“ï¼Œä¹Ÿä¸æ•¢å»ç ”ç©¶ï¼‰ã€‚

æœ€è¿‘åˆåœ¨æ£é¼“æ£é¼“è¿™ä¸ªå°åŠ©æ‰‹ï¼Œé‚æ¡èµ·äº†ä¹‹å‰çœ‹è¿‡çš„wechatyã€‚å¯¹ï¼ï¼ï¼å°±æ˜¯ä»–ï¼ï¼ï¼ä»–æ¥äº†~~

è€è§„çŸ©ï¼Œå…ˆæ’©å§ï¼ˆğŸ¨ğŸ¨ï¼‰

### ç®€ä»‹ï¼š

*   [å®˜æ–¹ï¼ˆgitï¼‰](https://github.com/wechaty)
*   è¯­è¨€ï¼šnode(TypeScript )ï¼Œpythonï¼Œjavaï¼ˆé¡¹ç›®å¤šæ˜¯æ”¯æŒnodeï¼Œä¸€äº›æ˜¯å¼€æºäº†pythonå’Œjavaï¼›çœ‹issuesè¯´æ˜¯nodeé¡¹ç›®æ”¯æŒçš„æ›´å®Œç¾~~å’±ä¹Ÿæ²¡ç»†ç©¶ï¼‰
*   åè®®ï¼šiPadã€Macã€WinPcã€Webç­‰ç­‰ï¼ˆæ”¯æŒçš„åè®®æŒºå¤šçš„ï¼Œå½“ç„¶ï¼Œwebåè®®çš„READMEé‡Œä¼šå£°æ˜ï¼Œç™»å½•ä¸äº†webç‰ˆå¾®ä¿¡çš„å·ä¸èƒ½æ­£å¸¸ä½¿ç”¨ï¼‰
*   ä½¿ç”¨ï¼šè¿™é‡Œæœ‰ä¸ªä¸œä¸œè¦æå‰å£°æ˜ä¸‹ï¼štokenï¼Œwechatyçš„æœåŠ¡éƒ½ä¾èµ–äºtokenï¼Œæœ‰ä¸ªåˆæ³•çš„tokenæ‰èƒ½æ­£å¸¸ä½¿ç”¨wechatyçš„æœåŠ¡ï¼›åé¢ä¼šç»†è¯´
*   å…è´¹ï¼šå‚ä¸å¼€æºæ¿€åŠ±è®¡åˆ’â†’[ä¼ é€é—¨(ç‚¹å®ƒ)](https://github.com/juzibot/Welcome/wiki/Everything-about-Wechaty#2%E5%85%8D%E8%B4%B9Token%E5%8F%82%E4%B8%8E%E5%BC%80%E6%BA%90%E6%BF%80%E5%8A%B1%E8%AE%A1%E5%88%92)
*   æ”¶è´¹ï¼šå®˜æ–¹å‘å¸ƒæ˜¯200ï¿¥/å·/æœˆï¼Œå…·ä½“â†’[ä¼ é€é—¨(ç‚¹å®ƒ)](https://github.com/juzibot/Welcome/wiki/Everything-about-Wechaty#3%E4%BB%98%E8%B4%B9Token%E7%9B%B4%E6%8E%A5%E5%92%A8%E8%AF%A2%E5%95%86%E5%8A%A1%E8%B4%AD%E4%B9%B0)
*   è¯´æ˜ï¼šå®˜æ–¹å£°æ˜ï¼Œä¸€ä¸ªtokenåŸåˆ™ä¸Šåªèƒ½åŒæ—¶åœ¨çº¿ä¸€ä¸ªå¾®ä¿¡å·ï¼Œè¿™é‡Œçš„æ„æ€å°±æœ‰æ„å‘³äº†ã€‚è¿™ä¸ªtokenä¸ä¼šç»‘å®šä½ çš„å¾®ä¿¡å·ï¼Œä½†æ˜¯å‘¢ï¼Œåªèƒ½åŒæ—¶åœ¨çº¿ä¸€ä¸ªå¾®ä¿¡ï¼Œä½ è¦æ˜¯æƒ³åšnä¸ªå¾®ä¿¡çš„ç§åŸŸï¼Œé‚£å°±éœ€è¦nä¸ªtoken

### å­¦ä¹ ï¼š

*   æˆ‘è¿™é‡Œçš„é¡¹ç›®æ˜¯åŸºäº[wechaty-puppet-hostie](https://github.com/wechaty/wechaty-puppet-hostie)
*   [å®˜æ–¹APIæ–‡æ¡£](https://wechaty.js.org/docs/api/)ï¼ˆå¾ˆé‡è¦ï¼ï¼ï¼ä¸€å®šè¦å…ˆçœ‹æ–‡æ¡£å†ä¸‹æ‰‹ï¼Œå¦‚æœè¦åŸºäºè¿™ä¸ªå¼€å‘ï¼Œä¸€å®šè¦æŠŠå®ƒå½“ä½œæ‰‹å†Œï¼‰
*   [å®˜æ–¹å‚è€ƒç¤ºä¾‹](https://github.com/juzibot/donut-tester#example)ï¼ˆè‡³äºæˆ‘ä¸ºä»€ä¹ˆåŸºäºè¿™ä¸ªç¤ºä¾‹ï¼Œå› ä¸ºå®˜æ–¹ç»™çš„æˆ‘15å¤©å…è´¹tokenæ˜¯donutç‰ˆï¼ŒåŸºäºwindowsåè®®ï¼‰
*   è¯­è¨€ï¼šä¸»è¦æ˜¯nodejsï¼ŒåŸºäºexpressæ¡†æ¶â†’[ä¼ é€é—¨ï¼ˆç‚¹å®ƒï¼‰](https://www.expressjs.com.cn/)
*   æŠ€æœ¯æ ˆï¼šexpressæ¡†æ¶ï¼ˆå‰ç«¯ejsï¼‰ï¼Œsocket io
*   åè¯è§£é‡Š
    *   tokenï¼šå®˜æ–¹è§£é‡Š

        > *   Our Mission: Make it easy to build a WeChat Chatbot for developers.
        >
        >     We provide a **free** access using [iPad protocol](https://www.lizenghai.com/goto/?url=https://github.com/wechaty/wechaty-puppet-padplus) for the developers who have a strong will and ability to build a valuable chatbot for users.
        >
        >     Any developers can add JuziBOT Incâ€™s staff ( **Wechat number :** juzibot) as a Wechat friend. You will receive a review form after adding. If you pass the review and willing to write a blog in Wechaty , you can use our iPad protocol for freeï¼
        >
        >     æˆ‘ä»¬çš„ä½¿å‘½ï¼šè½»æ¾ä¸ºå¼€å‘äººå‘˜æ„å»ºå¾®ä¿¡èŠå¤©æœºå™¨äºº
        >
        >     æˆ‘ä»¬ä¸ºæœ‰å¼ºçƒˆæ„æ„¿å’Œèƒ½åŠ›ä¸ºç”¨æˆ·æ„å»ºæœ‰ä»·å€¼çš„èŠå¤©æœºå™¨äººçš„å¼€å‘äººå‘˜æä¾›äº†ä½¿ç”¨[iPadåè®®](https://www.lizenghai.com/goto/?url=https://github.com/wechaty/wechaty-puppet-padplus)çš„**å…è´¹**è®¿é—®æƒé™
        >
        >     ä»»ä½•å¼€å‘äººå‘˜éƒ½å¯ä»¥å°†JuziBOT Incçš„å·¥ä½œäººå‘˜ï¼ˆ**å¾®ä¿¡ç¼–å·ï¼š**juzibotï¼‰æ·»åŠ ä¸ºå¾®ä¿¡å¥½å‹ã€‚æ·»åŠ åï¼Œæ‚¨å°†æ”¶åˆ°ä¸€ä»½å®¡æŸ¥è¡¨ã€‚å¦‚æœæ‚¨é€šè¿‡å®¡æŸ¥å¹¶æ„¿æ„åœ¨Wechatyä¸­å†™åšå®¢ï¼Œåˆ™å¯ä»¥å…è´¹ä½¿ç”¨æˆ‘ä»¬çš„iPadåè®®ï¼
        >

        *   æ„æ€æ˜¯æˆ‘ä»¬æäº¤å®¡æŸ¥è¡¨åï¼Œä¼šè·å¾—ä¸ºæœŸ15å¤©çš„å…è´¹Tokenï¼›æƒ³è¦è·å–é•¿æœŸæœ‰æ•ˆçš„å…è´¹tokenï¼Œé‚£å°±å‚åŠ æ‰€è°“çš„å¼€æºæ¿€åŠ±è®¡åˆ’ï¼Œå°±æ˜¯åœ¨15å¤©åï¼Œéœ€è¦æäº¤ä¸€ä¸ªMVP(æœ€å°å¯è¡ŒåŒ–äº§å“)çš„Githubä»“åº“ï¼ŒWechatyä¼šå°†å…¶forkåˆ°ç¤¾åŒºä¸­çš„åŒæ—¶ï¼Œä¼šæä¾›ä¸€ä¸ªé•¿æœŸå…è´¹Token

    *   [wechaty-puppet-padplus](https://www.lizenghai.com/goto/?url=https://github.com/wechaty/wechaty-puppet-padplus)ï¼šåŸºäºipadåè®®çš„å¾®ä¿¡æœºå™¨äºº
    *   [wechaty-puppet-hostie](https://github.com/wechaty/wechaty-puppet-hostie)ï¼šåŸºäºwindowsåè®®çš„æœºå™¨äºº

### åˆæ­¥éœ€æ±‚ï¼š

*   å…³é”®å­—è‡ªåŠ¨é€šè¿‡å¥½å‹éªŒè¯
    *   å½“æœ‰äººæ·»åŠ æœºå™¨äººæ—¶ï¼Œåˆ¤æ–­éªŒè¯æ¶ˆæ¯å…³é”®å­—åé€šè¿‡æˆ–ç›´æ¥é€šè¿‡
    *   é€šè¿‡éªŒè¯åè‡ªåŠ¨å›å¤å¹¶ä»‹ç»æœºå™¨äººåŠŸèƒ½
*   ç§èŠå…³é”®å­—å›å¤
    *   ä¾‹å¦‚å›å¤ `åŠ ç¾¤` æ¨é€ç¾¤èŠé‚€è¯·
    *   ä¾‹å¦‚å›å¤ `ä½œè€…å¾®ä¿¡` æ¨é€ä½œè€…å¾®ä¿¡åç‰‡
    *   ä¾‹å¦‚å›å¤ ç™½åå•`ç¾¤å` é‚€è¯·å…¥ç¾¤
*   è‡ªåŠ¨èŠå¤©
    *   å¯¹æ¥AIæœºå™¨äººï¼Œè¿™é‡Œç§‘æ™®æ¨èå…è´¹æœºå™¨äººapiå’Œ[å…è´¹å¤©æ°”æŸ¥è¯¢api](http://www.tianqiapi.com/)ï¼Œå›å¤ èŠœæ¹–å¤©æ°”
    *   ç¾¤èŠä¸­é€šè¿‡ `@[æœºå™¨äºº]xxx` å¯ä»¥å’Œæœºå™¨äººèŠå¤©
    *   ç§èŠå‘é€æ¶ˆæ¯å³å¯èŠå¤©
    *   å‘æœºå™¨äººè¯¢é—®å¤©æ°”
*   åŠ å…¥ç¾¤èŠè‡ªåŠ¨æ¬¢è¿
    *   å½“æ–°çš„å°ä¼™ä¼´åŠ å…¥ç¾¤èŠåè‡ªåŠ¨ `@[æ–°çš„å°ä¼™ä¼´]` å‘ä¸€ä¸ªæ–‡å­—æ¬¢è¿
*   webèŠå¤©
    *   å‰å°è·å–å¥½å‹åˆ—è¡¨
    *   é€šè¿‡socketå®æ—¶å‘å‰å°æ¨é€è¿˜æœ‰æ¶ˆæ¯
    *   å®ç°å‰å°å‘å¥½å‹å‘é€æ¶ˆæ¯

### é¡¹ç›®ç»“æ„ï¼š

```bash
|--bin/
|----www # é¡¹ç›®å¯åŠ¨æ–‡ä»¶
|--publick/ #é™æ€èµ„æºæœ¨ç‹¼
|----image/
|----javascripts/
|----stylesheets/
|------style.css
|--routes/ # è·¯ç”±
|----index.js
|----users.js
|--views/  # æ¨¡æ¿
|----error.ejs
|----index.ejs
|--wechaty/
|----onFriendShip.js # å¥½å‹æ·»åŠ ç›‘å¬å›è°ƒ
|----onMessage.js    # æ¶ˆæ¯ç›‘å¬å›è°ƒ
|----onRoomJoin.js   # è¿›å…¥ç¾¤èŠç›‘å¬å›è°ƒ
|----onRoomLeave.js  # é€€å‡ºç¾¤èŠç›‘å¬å›è°ƒ
|--app.js    # æ ¸å¿ƒ
|--common.js # å…¬å…±æ–¹æ³•
|--config.js # é…ç½®æ–‡ä»¶
|--donut.js  # wechatyæ ¸å¿ƒ
|--package.js
|--package-lock.js
|--socketio.js # socketæ ¸å¿ƒ
```


æ’¸èµ·è¢–å­å¹²ï¼Œå¼€å¹²
========

é¡¹ç›®åˆå§‹åŒ–
-----

**æ–°å»ºæ–‡ä»¶å¤¹wechaty-liteï¼Œè¿›å…¥ç›®å½•æ‰§è¡Œcnpm init -y   (å¤§å®¶éƒ½çŸ¥é“å›½å†…ç›´æ¥ä½¿ç”¨ npm çš„å®˜æ–¹é•œåƒæ˜¯éå¸¸æ…¢çš„ï¼Œè¿™é‡Œæ¨èä½¿ç”¨[æ·˜å® NPM é•œåƒ](https://www.runoob.com/nodejs/nodejs-npm.html#taobaonpm)ã€‚)**

```bash
cnpm init -y
```

**å®‰è£…æ ¸å¿ƒåŒ…**

```bash
// Wechatyæ ¸å¿ƒåŒ…
cnpm install --save wechaty
// wechaty-puppetåè®®åŒ…
cnpm install --save wechaty-puppet
//å¼€å‘è¿‡ç¨‹ä¸­ï¼Œè¿˜éœ€è¦ç”¨åˆ°qrcode-terminalè¿™ä¸ªåŒ…ï¼Œä½œç”¨å°±æ˜¯å°†äºŒç»´ç è¾“å‡ºåœ¨ç»ˆç«¯æ¥ä¾›æˆ‘ä»¬æ‰«ç ç™»å½•
cnpm install --save qrcode-terminal

//node5ä»¥åå¯ä»¥ä¸ç”¨ä½¿ç”¨--save
```

æ ¸å¿ƒä»£ç ï¼š
-----

**é…ç½®æ–‡ä»¶config.js**

```javascript

module.exports = {
    // puppet_donu Token
    token: "PUT_YOUR_TOKEN_HERE",
    // æœºå™¨äººåå­—
    name: "Oreo",
    // æˆ¿é—´/ç¾¤èŠ
    room: {
        // ç®¡ç†ç¾¤ç»„åˆ—è¡¨
        roomList: {
            // ç¾¤å(ç”¨äºå±•ç¤ºï¼Œå»ºè®®ç”¨ç¾¤å) : ç¾¤id(å…ˆè¿è¡Œç¨‹åºï¼Œè·å–ç¾¤idï¼ˆroomIdï¼‰)
            å¤§å®¶æœ‰é’±èŠ±: "xxxx1@chatroom",
            wechatyå¼€å‘ç»„: "xxxx2@chatroom"
        },
        // åŠ å…¥æˆ¿é—´å›å¤
        roomJoinReply: `\n æ‚¨å¥½ï¼Œè¿›ç¾¤è¯·å…ˆçœ‹ç¾¤å…¬å‘Šï¼è‡ªè§‰éµå®ˆç¾¤è§„åˆ™ï¼Œæ–‡æ˜äº¤æµï¼æœ€åï¼Œè¯·ç”¨ç®€çŸ­çš„è¯å‘å¤§å®¶ä»‹ç»ä½ è‡ªå·±ï¼ğŸ˜Š \n\n Hello, please read the group announcement first! Consciously abide by the group rules, civilized communication! Finally, please introduce yourself in short words! ğŸ˜Š`,
        autoReturnRoomList: ['å¤§å®¶æœ‰é’±èŠ±', 'wechatyå¼€å‘ç»„']
    },
    // ç§äºº
    personal: {
        // å¥½å‹éªŒè¯è‡ªåŠ¨é€šè¿‡å…³é”®å­—
        addFriendKeywords: ["12345", "ä¸€äºŒä¸‰å››äº”", "ä¸Šå±±æ‰“è€è™"],
        // æ˜¯å¦å¼€å¯åŠ ç¾¤
        addRoom: true,
        //é˜»æ–­ä¸ä½¿ç”¨æœºå™¨äººå›å¤çš„å¥½å‹åˆ—è¡¨ï¼ˆwxidï¼‰
        robotBlockList: ['tengxun', 'tengxun1'],
        //é˜»æ–­ä¸ä½¿ç”¨æœºå™¨äººç¾¤å›å¤çš„å¥½å‹åˆ—è¡¨ï¼ˆwxidï¼‰
        robotQunBlockList: ['tengxun', 'tengxun2']
    },
    //ä¸‰æ–¹apiä¿¡æ¯
    thirdApi: {
        // http://www.itpk.cn/    aiæœºå™¨äºº
        itpk: {
            apiKey: "xxx",
            apiSecret: "xxx"
        },
        // http://www.tianqiapi.com/    å¤©æ°”é¢„æŠ¥
        tianqiapi: {
            appId: "zzz",
            appSecret: "zzz"
        }
    }
};
```

**å¯åŠ¨æ–‡ä»¶www**

åœ¨Create HTTP server.åå¼•å…¥socketioå’Œwechatyï¼Œè¿›è¡Œå¯åŠ¨

*   å¼•å…¥socketioï¼Œè°ƒç”¨å°è£…çš„getSocketio()è¿›è¡Œåˆå§‹åŒ–å¯åŠ¨ï¼›
*   å¼•å…¥donutï¼Œè°ƒç”¨å°è£…çš„run()è¿›è¡Œåˆå§‹åŒ–å¯åŠ¨ï¼›

```javascript
/**
 * Create socket.io server.
 */

var io = require('../socketio');
io.getSocketio(server);


/**
 * Create puppet_donut server.
 */

var puppet_donut = require('../donut');
puppet_donut.run();
```

**socketæœåŠ¡ socketio.jsæ–‡ä»¶**

è¯¥ç¤ºä¾‹ä¸»è¦ä»‹ç»äº†socketå‘é€æœºåˆ¶ï¼Œå¦‚å‘é€ç»™è‡ªå·±ï¼Œå‘é€ç»™åˆè‡ªå·±å¤–çš„å…¶ä»–ç”¨æˆ·ï¼ˆå¹¿æ’­ï¼‰ï¼Œæ¨é€ç»™æ‰€æœ‰äººï¼›ï¼ˆè¿˜å¯ä»¥æ¨é€ç»™æŸä¸€ä¸ªsocketè¿æ¥ç”¨æˆ·ï¼Œé€šè¿‡idï¼Œè¿™é‡Œä¸ä»‹ç»äº†ï¼‰

1.  ç›‘å¬å®¢æˆ·ç«¯çš„æ¶ˆæ¯ï¼›
2.  ç›‘å¬å®¢æˆ·ç«¯çš„å¾®ä¿¡æ¶ˆæ¯å¹¶å‘é€ç»™ç›¸å…³å¥½å‹ï¼›
3.  å°è£…æ¥å£sendWechatLoginMsgã€sendWechatMsgç»™wechatyè°ƒç”¨ï¼›

```javascript

var socketio = {};
const common = require('./common');

// è·å–io

var io = null;

//å¾®ä¿¡ç™»å½•æ¶ˆæ¯æ¨é€è‡³å®¢æˆ·ç«¯
socketio.sendWechatLoginMsg = function(msg){
    io.emit('getWechatLoginMsg', + msg);//è§¦å‘æ‰€æœ‰ç”¨æˆ·
};

//å›è°ƒæ¶ˆæ¯æ¨é€è‡³å®¢æˆ·ç«¯
socketio.sendWechatMsg = function(msg){
    io.emit('getWechatMsg', 'ã€' + common.currentDateTime() + 'ã€‘' + msg);//è§¦å‘æ‰€æœ‰ç”¨æˆ·
};

//åˆå§‹åŒ–socketio
socketio.getSocketio = function(server){ // http(s) server

    io = require("socket.io")(server);

    //ç›‘å¬è¿æ¥æˆåŠŸ
    io.sockets.on('connection', function (socket) {
        console.log('è¿æ¥æˆåŠŸ');

        //ç›‘å¬äº‹ä»¶event01
        socket.on('event01',function(){ // å¤„ç†æ¥è‡ªå®¢æˆ·ç«¯çš„â€™event01â€™äº‹ä»¶

            console.log('ç›‘å¬ç‚¹å‡»äº‹ä»¶');

            var datas = [1,2,3,4,5];

            socket.emit('event02', {datas: datas}); // ç»™è¯¥å®¢æˆ·ç«¯å‘é€event02äº‹ä»¶

            socket.broadcast.emit('event02', {datas: datas}); // å‘é€ç»™å…¶å®ƒå®¢æˆ·ç«¯

        });

        //ç›‘å¬äº‹ä»¶send
        socket.on("send", data => {  // ç›‘å¬çš„é¢‘é“å¿…é¡»å’Œå®¢æˆ·ç«¯ç›‘å¬çš„é¢‘é“ç›¸åŒï¼Œç­‰å¾…æ¶ˆæ¯
            // io.emit("ç›‘å¬é¢‘é“", "å‘é€çš„ä¿¡æ¯");  // å‘æ‰€æœ‰å®¢æˆ·ç«¯å‘é€ä¿¡æ¯
            console.log('å®¢æˆ·ç«¯å‘é€çš„å†…å®¹ï¼š', data);
            io.emit('getMsg', 'æˆ‘æ˜¯è¿”å›çš„æ¶ˆæ¯... ...' + common.currentDateTime());//è§¦å‘æ‰€æœ‰ç”¨æˆ·
            // socket.emit('getMsg', 'æˆ‘æ˜¯è¿”å›çš„æ¶ˆæ¯... ...' + new Date().getTime());//è§¦å‘å½“å‰ç”¨æˆ·
            // socket.broadcast.emit('getMsg', 'æˆ‘æ˜¯è¿”å›çš„æ¶ˆæ¯... ...' + new Date().getTime());//è§¦å‘é™¤å»è¯¥ç”¨æˆ·ä»¥å¤–çš„ç”¨æˆ·
            // io.to(socketedId).emit('getMsg', 'æˆ‘æ˜¯è¿”å›çš„æ¶ˆæ¯... ...' + new Date().getTime());//è§¦å‘æŒ‡å®šç”¨æˆ·
        });

        //ç›‘å¬å‰å°å‘é€å¾®ä¿¡æ–‡æœ¬æ¶ˆæ¯ï¼Œå¹¶è¿›è¡Œæ¶ˆæ¯å‘é€
        socket.on("sendWechatText", data => {
            console.log('å®¢æˆ·ç«¯å‘é€çš„å†…å®¹ï¼š', data);
            var puppet_donut = require('./donut');
            puppet_donut.sendTextMsgToContact(data.friendNick, data.wechatContent);
            io.emit('sendWechatTextCallback', 'å¾®ä¿¡æ¶ˆæ¯å‘é€æˆåŠŸ... ...' + common.currentDateTime());//è§¦å‘æ‰€æœ‰ç”¨æˆ·
        });

        // æ›´å¤šäº‹ä»¶ï¼Œå°±æ›´å¤šå¤„ç†å‡½æ•°

        // ......

        socket.on("disconnect", data => {  // å®¢æˆ·ç«¯æ–­å¼€é“¾æ¥
            console.log('æ–­å¼€è¿æ¥ï¼š', data);
        });

        socket.on('error', function (err) {   //å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘
            console.log(err);
        });

        setTimeout( () => {
            socket.emit('getMsg', 'æˆ‘æ˜¯åˆå§‹åŒ–3såçš„è¿”å›æ¶ˆæ¯... ...');
        }, 3000)

    })

};

module.exports = socketio;
```

**donutæœåŠ¡ donut.jsæ–‡ä»¶**

è¯¥ç¤ºä¾‹ä¸»è¦ä»‹ç»äº†å¼•ç”¨wechatyåŒ…ï¼Œå®ç°wechatyåˆå§‹åŒ–ã€åŠ å…¥ç¾¤èŠã€é€€å‡ºç¾¤èŠã€æ¶ˆæ¯ç­‰ç›‘å¬å’Œå¤šç§å‘é€æ¶ˆæ¯å‡½æ•°å°è£…

*   botåˆå§‹åŒ–ï¼›
*   å®ç°botç›‘å¬ï¼ˆOnMessageã€OnRoomJoin...ï¼‰ï¼›
*   æ¶ˆæ¯å‘é€ï¼ˆæ–‡æœ¬ã€åª’ä½“ã€é“¾æ¥ç­‰æ¶ˆæ¯ï¼‰ï¼›

```javascript

const { FileBox } = require("wechaty");

var puppet_donut = {};

//è·å–botï¼ˆæœºå™¨äººï¼‰
var bot = null;

//å‘é€æ–‡æœ¬æ¶ˆæ¯ç»™è”ç³»äºº
puppet_donut.sendTextMsgToContact = async function(friendName, text){
    const contact = await bot.Contact.find({name: friendName});  //æ ¹æ®æ˜µç§°æœç´¢å¥½å‹ change 'lijiarui' to any of your contact name in wechat
    if(!contact) return; //å¥½å‹ä¸å­˜åœ¨ç›´æ¥è¿”å›
    await contact.say(text); //è°ƒç”¨contactå¯¹è±¡çš„sayæ–¹æ³•å‘é€æ¶ˆæ¯ï¼Œcontactå¯¹è±¡å¾ˆå¤šæ–¹æ³•ï¼Œå‚è€ƒå®˜æ–¹æ–‡æ¡£
};

//å‘é€åª’ä½“æ¶ˆæ¯ç»™è”ç³»äºº
puppet_donut.sendMediaMsgToContact = async function(friendName, fileUrl, filePath){
    const contact = await bot.Contact.find({name: friendName});  // change 'lijiarui' to any of your contact name in wechat
    if(!contact) return;
    if(fileUrl){
        const fileBox1 = FileBox.fromUrl(fileUrl);
        await contact.say(fileBox1)
    }
    if(filePath){
        const fileBox2 = FileBox.fromFile(filePath);
        await contact.say(fileBox2)
    }
};

//å‘é€åç‰‡æ¶ˆæ¯ç»™è”ç³»äºº
puppet_donut.sendContactCardMsgToContact = async function(friendName, contactId){
    const contact = await bot.Contact.find({name: friendName});  // change 'lijiarui' to any of your contact name in wechat
    if(!contact) return;
    const contactCard = bot.Contact.load(contactId);
    await contact.say(contactCard);
};

//å‘é€é“¾æ¥æ¶ˆæ¯ç»™è”ç³»äºº
puppet_donut.sendUrlLinkMsgToContact = async function(friendName, description, thumbnailUrl, title, url){
    const contact = await bot.Contact.find({name: friendName});  // change 'lijiarui' to any of your contact name in wechat
    if(!contact) return;
    const urlLink = new UrlLink ({
        description : description,
        thumbnailUrl: thumbnailUrl,
        title       : title,
        url         : url,
    });
    await contact.say(urlLink);
};

//å‘é€å°ç¨‹åºæ¶ˆæ¯ç»™è”ç³»äºº
puppet_donut.sendMiniProgramMsgToContact = async function(friendName, username, appid, title, pagepath, description, thumbnailurl){
    const contact = await bot.Contact.find({name: friendName});  // change 'lijiarui' to any of your contact name in wechat
    if(!contact) return;
    const miniProgram = new MiniProgram ({
        username           : username,     //get from mp.weixin.qq.com
        appid              : appid,        //optional, get from mp.weixin.qq.com
        title              : title,        //optional
        pagepath           : pagepath,     //optional
        description        : description,  //optional
        thumbnailurl       : thumbnailurl, //optional
    });
    await contact.say(miniProgram)
};

//åˆå§‹åŒ–è°ƒç”¨
puppet_donut.run = function(){

    const { Wechaty } = require('wechaty');
    const { ScanStatus } = require('wechaty-puppet');
    const QrcodeTerminal = require('qrcode-terminal');
    const io = require('./socketio');
    const config = require("./config");

    const onRoomJoin = require("./wechaty/onRoomJoin");     // åŠ å…¥æˆ¿é—´ç›‘å¬å›è°ƒ
    const onRoomLeave = require("./wechaty/onRoomLeave");   // é€€å‡ºæˆ¿é—´ç›‘å¬å›è°ƒ
    const onMessage = require("./wechaty/onMessage");       // æ¶ˆæ¯ç›‘å¬å›è°ƒ
    const onFriendShip = require("./wechaty/onFriendShip"); // å¥½å‹æ·»åŠ ç›‘å¬å›è°ƒ

    const token = config.token;

    bot = new Wechaty({
        puppet: 'wechaty-puppet-hostie',
        puppetOptions: {
            token,
        },
        name: config.name
    });

    bot
        .on('scan', (qrcode, status) => {
            if (status === ScanStatus.Waiting) {
                QrcodeTerminal.generate(qrcode, {
                    small: true
                });
                io.sendWechatMsg("è¯·æ‰«æäºŒç»´ç è¿›è¡Œç™»å½•>>>>>>>>>>>>>>>>>>>");
            }
        })
        .on('login', async user => {
            console.log(`user: ${JSON.stringify(user)}`);
            io.sendWechatMsg("ç™»å½•æˆåŠŸ>>>>>>>>>>>>>>>>>>>");
            var loginInfo = {
                nick: config.name,
                avatar: user.payload.avatar
            };
            io.sendWechatLoginMsg(loginInfo);
        })
        .on("room-join", onRoomJoin)    // åŠ å…¥ç¾¤èŠç›‘å¬
        .on("room-leave", onRoomLeave)  // é€€å‡ºç¾¤èŠæˆ¿é—´ç›‘å¬
        .on("message", onMessage(bot))  // æ¶ˆæ¯ç›‘å¬
        .on("friendship", onFriendShip) // å¥½å‹æ·»åŠ ç›‘å¬
        .start();
};

module.exports = puppet_donut;
```

### Wechatyç›‘å¬

è¿™è¾¹é‡ç‚¹æè¿°ä¸‹wechatyçš„ç›‘å¬ç¤ºä¾‹ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå•ç‹¬æŠŠå‡ ä¸ªç›‘å¬ä¸šåŠ¡ç»™æŠ½å‡ºæ¥åˆ°wechatyç›®å½•ä¸‹çš„åŸå› ä¹‹ä¸€ã€‚

*   scan                //æ‰«ç ç™»å½•ç›‘å¬
*   login                //ç™»å½•æˆåŠŸç›‘å¬
*   room-join        //åŠ å…¥ç¾¤èŠç›‘å¬
*   room-leave     //é€€å‡ºç¾¤èŠç›‘å¬
*   message        //æ¶ˆæ¯é€šçŸ¥ç›‘å¬
*   friendship       //å¥½å‹æ·»åŠ ç›‘å¬

### **åˆå§‹åŒ–**

```javascript
    bot = new Wechaty({
        puppet: 'wechaty-puppet-hostie',
        puppetOptions: {
            token,
        },
        name: config.name
    });
```

### å‘é€æ–‡æœ¬æ¶ˆæ¯ç»™å¥½å‹

```javascript
//å‘é€æ–‡æœ¬æ¶ˆæ¯ç»™è”ç³»äºº
puppet_donut.sendTextMsgToContact = async function(friendName, text){
    const contact = await bot.Contact.find({name: friendName});  //æ ¹æ®æ˜µç§°æœç´¢å¥½å‹ change 'lijiarui' to any of your contact name in wechat
    if(!contact) return; //å¥½å‹ä¸å­˜åœ¨ç›´æ¥è¿”å›
    await contact.say(text); //è°ƒç”¨contactå¯¹è±¡çš„sayæ–¹æ³•å‘é€æ¶ˆæ¯ï¼Œcontactå¯¹è±¡å¾ˆå¤šæ–¹æ³•ï¼Œå‚è€ƒå®˜æ–¹æ–‡æ¡£
};
```

è¿™é‡Œä¼ å…¥ä¸¤ä¸ªå‚æ•°

*   friendName  //å¥½å‹æ˜µç§°ï¼Œè¿™é‡Œå¯ä»¥è°ƒç”¨å¯¹è±¡Contactçš„find({name: friendName})å‡½æ•°è¿›è¡Œå¥½å‹æŸ¥è¯¢
*   text               //å‘é€çš„æ–‡æœ¬å†…å®¹

å…¶ä»–çš„å‘é€æ–¹å¼åœ¨ä»£ç é‡Œï¼Œè¿™é‡Œç›´æ¥çœ‹ä»£ç ï¼Œä¸ä¸€ä¸€è§£é‡Šï¼ˆä»£ç è¯¦ç»†æ³¨é‡Šï¼Œå»ºè®®å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼‰

### **ç›‘å¬é…ç½®å¯åŠ¨**

```javascript
    bot
        .on('scan', (qrcode, status) => {
            if (status === ScanStatus.Waiting) {
                QrcodeTerminal.generate(qrcode, {
                    small: true
                });
                io.sendWechatMsg("è¯·æ‰«æäºŒç»´ç è¿›è¡Œç™»å½•>>>>>>>>>>>>>>>>>>>");
            }
        })
        .on('login', async user => {
            console.log(`user: ${JSON.stringify(user)}`);
            io.sendWechatMsg("ç™»å½•æˆåŠŸ>>>>>>>>>>>>>>>>>>>");
            var loginInfo = {
                nick: config.name,
                avatar: user.payload.avatar
            };
            io.sendWechatLoginMsg(loginInfo);
        })
        .on("room-join", onRoomJoin)    // åŠ å…¥ç¾¤èŠç›‘å¬
        .on("room-leave", onRoomLeave)  // é€€å‡ºç¾¤èŠæˆ¿é—´ç›‘å¬
        .on("message", onMessage(bot))  // æ¶ˆæ¯ç›‘å¬
        .on("friendship", onFriendShip) // å¥½å‹æ·»åŠ ç›‘å¬
        .start();
```

### **scan**ï¼ˆé¡¾åæ€ä¹‰ï¼Œæ˜¯ç”¨äºæ‰«ç ç™»å½•çš„ä¸€ä¸ªç›‘å¬ï¼‰

```javascript
                QrcodeTerminal.generate(qrcode, {
                    small: true
                });
```

è¿™é‡Œä»£ç è¾ƒç®€å•ï¼Œæ„æ€æ˜¯å‰é¢é€šè¿‡

```javascript
const QrcodeTerminal = require('qrcode-terminal');
```

å¼•ç”¨qrcode-terminalæ¨¡å—ï¼Œç”¨äºåœ¨ç»ˆç«¯è¿›è¡ŒäºŒç»´ç è¾“å‡ºï¼Œæ–¹ä¾¿æˆ‘ä»¬æµ‹è¯•æ‰«ç ï¼›

æˆ‘ä»¬å€ŸåŠ©`Qrterminal.generate`è¿™ä¸ªAPIå°† qr ç è¾“å‡ºåˆ°ç»ˆç«¯è€Œå·²ï¼Œåé¢é‚£ä¸ª`small`å‚æ•°æ˜¯å› ä¸º`qrcode-terminal` è¿™ä¸ªåŒ…é»˜è®¤è¾“å‡ºçš„äºŒç»´ç å¾ˆå¤§ï¼Œç»™å®ƒå˜å°ä¸€äº›ï¼›

è¿™è¾¹æœ‰ä¸€ä¸ªå‘ï¼Œåœ¨webstormä¸Šæ‰“ç çš„æ—¶å€™ï¼Œåœ¨ç»ˆç«¯è¾“å‡ºçš„äºŒç»´ç æ˜¯è¿™æ ·çš„ï¼Œ

![](https://img-blog.csdnimg.cn/20201210101957109.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3RvcGhpZ2htaQ==,size_16,color_FFFFFF,t_70)

è¿™æ—¶å€™æˆ‘ä»¬éœ€è¦æŠŠè¿™äº›å­—ç¬¦ä¸²å¤åˆ¶åˆ°ç å†œç¥å™¨notepad++é‡Œï¼Œå¦‚ä¸‹å›¾

![](https://img-blog.csdnimg.cn/20201210102118742.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3RvcGhpZ2htaQ==,size_16,color_FFFFFF,t_70)

ç„¶åè¿›è¡Œæ‰«ç ç™»å½•ï¼›

è¿™ä¸ªé—®é¢˜æˆ‘åœ¨centosä¸‹æµ‹è¯•æ˜¯æ²¡æœ‰è¿™ä¸ªé—®é¢˜ï¼Œç”Ÿäº§ä¸Šå¤§å®¶ä¸ç”¨æ‹…å¿ƒã€‚

### **onFriendShip**

ç”¨äºå¥½å‹ç›‘å¬çš„ç›‘å¬ï¼Œè¿™å—é€»è¾‘æ¯”è¾ƒç®€å•ï¼ˆå‚çœ‹åˆ«äººä»£ç ï¼Œç›´æ¥æ’¸è¿‡æ¥çš„ï¼Œå“ˆå“ˆå“ˆï¼Œåœ¨æ­¤æ„Ÿè°¢è¿™ä½æœ‹å‹ï¼‰ï¼›

ç›‘å¬å¥½å‹æ·»åŠ çš„è¯·æ±‚é€šçŸ¥ï¼Œå¦‚æœæ‰“æ‹›å‘¼ä¿¡æ¯hello()å†…å®¹ç¬¦åˆå…³é”®è¯åˆ—è¡¨ï¼Œåˆ™è¿›è¡Œå…äºˆé€šè¿‡accept();

è¿™é‡Œæˆ‘çœ‹äº†å®˜æ–¹æ–‡æ¡£ï¼Œå¯å®ç°çš„ä¸šåŠ¡å¾ˆå¤šï¼Œå¤§å®¶å¯å‚è€ƒå®˜æ–¹apiè¿›è¡Œæ›´å¤šä¸šåŠ¡æ‹“å±•ï¼ï¼ï¼

```javascript
const { Friendship } = require("wechaty");
// é…ç½®æ–‡ä»¶
const config = require("../config");
const io = require('../socketio');
// å¥½å‹æ·»åŠ éªŒè¯æ¶ˆæ¯è‡ªåŠ¨åŒæ„å…³é”®å­—æ•°ç»„
const addFriendKeywords = config.personal.addFriendKeywords;

// å¥½å‹æ·»åŠ ç›‘å¬å›è°ƒ
module.exports = async function onFriendShip(friendship) {
    let logMsg;
    try {
        logMsg = "æ·»åŠ å¥½å‹" + friendship.contact().name();
        console.log(logMsg);
        switch (friendship.type()) {
            /**
             * 1. æ–°çš„å¥½å‹è¯·æ±‚
             * è®¾ç½®è¯·æ±‚åï¼Œæˆ‘ä»¬å¯ä»¥ä»request.helloä¸­è·å¾—éªŒè¯æ¶ˆæ¯,
             * å¹¶é€šè¿‡`request.acceptï¼ˆï¼‰`æ¥å—æ­¤è¯·æ±‚
             */
            case Friendship.Type.Receive:
                // åˆ¤æ–­é…ç½®ä¿¡æ¯ä¸­æ˜¯å¦å­˜åœ¨è¯¥éªŒè¯æ¶ˆæ¯
                if (addFriendKeywords.some(v => v == friendship.hello())) {
                    logMsg = `è‡ªåŠ¨é€šè¿‡éªŒè¯ï¼Œå› ä¸ºéªŒè¯æ¶ˆæ¯æ˜¯"${friendship.hello()}"`;
                    // é€šè¿‡éªŒè¯
                    await friendship.accept()
                } else {
                    logMsg = "ä¸è‡ªåŠ¨é€šè¿‡ï¼Œå› ä¸ºéªŒè¯æ¶ˆæ¯æ˜¯: " + friendship.hello();
                }
                break;

            /**
             * 2. å‹è°Šç¡®è®¤
             */
            case Friendship.Type.Confirm:
                logMsg = "friend ship confirmed with " + friendship.contact().name();
                break
        }
        console.log(logMsg)
        io.sendWechatMsg(logMsg);
    } catch (e) {
        logMsg = e.message
    }
};
```

### onRoomJoin

è¿™é‡Œä¸»è¦ç›‘å¬ç”¨æˆ·åŠ å…¥æˆ¿é—´çš„å›è°ƒ

```javascript
// é…ç½®æ–‡ä»¶
const config = require("../config");
const io = require('../socketio');
// åŠ å…¥æˆ¿é—´å›å¤
const roomJoinReply = config.room.roomJoinReply;
// ç®¡ç†ç¾¤ç»„åˆ—è¡¨
const roomList = config.room.roomList;

// è¿›å…¥æˆ¿é—´ç›‘å¬å›è°ƒ room-ç¾¤èŠ inviteeList-å—é‚€è€…åå• inviter-é‚€è¯·è€…
module.exports = async function onRoomJoin(room, inviteeList, inviter) {
    // åˆ¤æ–­é…ç½®é¡¹ç¾¤ç»„idæ•°ç»„ä¸­æ˜¯å¦å­˜åœ¨è¯¥ç¾¤èŠid
    if (Object.values(roomList).some(v => v == room.id)) {
        // let roomTopic = await room.topic()
        inviteeList.map(c => {
            // å‘é€æ¶ˆæ¯å¹¶@
            console.log("ã€é‚€è¯·è€…ã€‘ï¼š" + inviter + " é‚€è¯· " + c + " å…¥ç¾¤");
            io.sendWechatMsg("ã€é‚€è¯·è€…ã€‘ï¼š" + inviter + " é‚€è¯· " + c + " å…¥ç¾¤");
            room.say(roomJoinReply, c)
        })
    }
};
```

è¿™é‡Œæˆ‘ä»¬è¯´æ˜ä¸‹ï¼Œå¦‚æœæ˜¯åœ¨é…ç½®ç™½åå•roomJoinReplyé‡Œçš„ç¾¤ï¼Œåªè¦æœ‰æ–°äººåŠ å…¥ï¼Œæˆ‘ä»¬å°±å‘ä¸€ä¸ªæ¬¢è¿è¯å¹¶@ä»–ä¸‹

è¿™äº›å†…å®¹æˆ‘ä»¬ç°åœ¨æ”¾åœ¨configä¸­ï¼Œå®é™…ä¸šåŠ¡è‚¯å®šæ˜¯æ”¾åœ¨dbä¸­ï¼Œä¸šåŠ¡å¯åŠ¨å»è·å–æˆ–å®æ—¶ç›‘å¬ï¼›

æ­¤å›è°ƒæ¥æ”¶ä¸‰ä¸ªå‚æ•°

*   room ç¾¤èŠå®ä¾‹
*   inviteeList å—é‚€è€…åå•
*   inviter é‚€è¯·è€…

æœ‰äº†æˆ¿é—´ï¼Œå—é‚€è€…ï¼Œé‚€è¯·è€…ï¼Œè¿™é‡Œå¯å®ç°çš„ä¸šåŠ¡å°±å¤šäº†~~æ­¤å¤„å•ªå•¦å•ªå•¦çœç•¥800å­—...

åšä¸€ä¸‹åˆ¤æ–­å°±å¯ä»¥äº†ï¼Œè¿™é‡Œçš„`room.id`å°±æ˜¯æˆ‘ä»¬é…ç½®çš„ç®¡ç†ç¾¤ç»„åˆ—è¡¨å¯¹è±¡roomJoinReplyçš„valueå€¼

ä¸ºä»€ä¹ˆè¦æœ‰ç®¡ç†ç¾¤ç»„åˆ—è¡¨å¯¹è±¡å‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬åœ¨ç™»å½•äº†ä¸€ä¸ªå¾®ä¿¡å·æ—¶ï¼Œç¾¤ç»„è¿›å…¥ç›‘å¬æ˜¯é’ˆå¯¹å¾®ä¿¡å·ä¸­æ‰€æœ‰ç¾¤ç»„çš„

æˆ‘çš„éœ€æ±‚æ˜¯è¦ç®¡ç†æˆ‘çš„ç¾¤ç»„ï¼Œæ‰€ä»¥äº‹å…ˆè·‘äº†ä¸‹ç¨‹åºï¼Œè¾“å‡ºäº†`room`ï¼Œç„¶åç¾¤é‡Œå‘ä¸ªæ¶ˆæ¯ï¼Œå°±æ‹¿åˆ°äº†æˆ‘æƒ³ç®¡ç†çš„ç¾¤ç»„æ‰€æœ‰ä¿¡æ¯ï¼Œidè‡ªç„¶ä¹Ÿåœ¨é‡Œé¢ï¼Œç„¶åå†™åˆ°äº†é…ç½®é‡Œï¼Œè¿™é‡Œè¾“å‡ºä¸€ä¸ªroomçš„èŠå¤©ä¿¡æ¯ç¤ºä¾‹ï¼Œè¿™é‡Œé¢çš„roomIdå°±æ˜¯æˆ¿å·

```javascript
{"_events":{},"_eventsCount":0,"id":"2098964982947510281","payload":{"filename":"","fromId":"å‘é€è€…å¾®ä¿¡å·","id":"209896498xxxxxæ¶ˆæ¯å”¯ä¸€id","mentionIdList":["wxid_diuxkznxxxxç¾¤é‡Œå¥½å‹wxidåˆ—è¡¨"],"roomId":"xxxx@chatroom","text":"@Oreo åŒ—äº¬å¤©æ°”","timestamp":1607568215000,"toId":"","type":7}}
```

æ¥ä¸‹æ¥å°±æ˜¯ï¼Œç›‘å¬åˆ°æ–°åŠ å…¥ï¼ŒæŠŠå—é‚€è€…åˆ—è¡¨éå†ä¸€ä¸‹ï¼Œä½¿ç”¨`room.say`æ–¹æ³•å‘é€ç¾¤æ¶ˆæ¯å³å¯ï¼Œå—é‚€è€…åˆ—è¡¨é‡Œå­˜çš„å°±æ˜¯åŠ å…¥çš„å¾®ä¿¡å·å®ä¾‹ï¼Œ`say` æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯è¦å‘é€çš„æ¶ˆæ¯ï¼Œç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯ä¸ºäº†@æ­¤äººä¸€ä¸‹ã€‚ã€‚ã€‚å…¶ä»–ä¸šåŠ¡å¼€å‘è¯·å‚è€ƒ[å®˜æ–¹æ–‡æ¡£ï¼ˆå†æ¥ä¸€ä¸ªä¼ é€é—¨ï¼‰](https://wechaty.js.org/docs/api/)

###

### onRoomLeave

ç›‘å¬ç”¨æˆ·é€€å‡ºç¾¤èŠ

```javascript
const io = require('../socketio');
// è¿›å…¥æˆ¿é—´ç›‘å¬å›è°ƒ room-ç¾¤èŠ leaver-é€€ç¾¤è€…
module.exports = async function onRoomLeave(room, leaver) {
    console.log("ç¾¤-ã€" + room.name + "ã€‘ï¼š" + leaver + " é€€ç¾¤");
    io.sendWechatMsg("ç¾¤-ã€" + room.name + "ã€‘ï¼š" + leaver + " é€€ç¾¤");
};
```

è¿™é‡Œçš„ä¸šåŠ¡æ›´ç®€å•äº†ï¼Œä¸»è¦æ˜¯ç›‘å¬ç”¨æˆ·æ¨å‡ºç¾¤èŠ

æ­¤å›è°ƒæ¥æ”¶ä¸‰ä¸ªå‚æ•°

*   room ç¾¤èŠå®ä¾‹
*   leaver é€€å‡ºç¾¤èŠè€…

### onMessage

ä¸»è¦ç›‘å¬æ¶ˆæ¯çš„æ¥æ”¶



```javascript
        // åˆ¤æ–­æ­¤æ¶ˆæ¯ç±»å‹æ˜¯å¦ä¸ºæ–‡æœ¬
        if (msg.type() == Message.Type.Text) {
            // åˆ¤æ–­æ¶ˆæ¯ç±»å‹æ¥è‡ªç¾¤èŠ
            if (msg.room()) {
                // è·å–ç¾¤èŠ
                const room = await msg.room();
                io.sendWechatMsg('ã€' + room.payload.topic + 'ã€‘@' + msg.from().name() + 'ï¼š' + msg.text());
                if(config.room.autoReturnRoomList.length > 0 && !config.room.autoReturnRoomList.includes(room.payload.topic)) return;//åˆ¤æ–­è¯¥ç¾¤æ˜¯å¦åœ¨é˜»æ–­åå•,å¦‚æœæ˜¯ç©ºæ•°ç»„ï¼Œåˆ™ä¸é˜»æ–­
                // æ”¶åˆ°æ¶ˆæ¯ï¼Œæåˆ°è‡ªå·±
                if (await msg.mentionSelf()) {
                    // è·å–æåˆ°è‡ªå·±çš„åå­—
                    // let self = await msg.to();//è¯¥å‡½æ•°è¿”å›null
                    // self = "@" + self.name();
                    let self = "@" + config.name;
                    // è·å–æ¶ˆæ¯å†…å®¹ï¼Œæ‹¿åˆ°æ•´ä¸ªæ¶ˆæ¯æ–‡æœ¬ï¼Œå»æ‰ @+åå­—
                    let sendText = msg.text().replace(self, "");

                    // è¯·æ±‚æœºå™¨äººæ¥å£å›å¤
                    let res = await requestRobot(sendText);

                    // è¿”å›æ¶ˆæ¯ï¼Œå¹¶@æ¥è‡ªäºº
                    room.say(res, msg.from());
                    return;
                }

                // æ”¶åˆ°æ¶ˆæ¯ï¼Œæ²¡æœ‰æåˆ°è‡ªå·±  å¿½ç•¥
            } else {
                // å›å¤ä¿¡æ¯æ˜¯å…³é”®å­— â€œåŠ ç¾¤â€
                io.sendWechatMsg('@' + msg.from().name() + 'ï¼š' + msg.text());
                if(config.personal.robotBlockList.includes(msg.from().id)) return;//åˆ¤æ–­è¯¥å¥½å‹æ˜¯å¦åœ¨é˜»æ–­åå•
                if(!config.personal.robotQunBlockList.includes(msg.from().id)){//åˆ¤æ–­è¯¥å¥½å‹æ˜¯å¦åœ¨ç¾¤é˜»æ–­åå•
                    if (await isAddRoom(msg)) return;

                    // å›å¤ä¿¡æ¯æ˜¯æ‰€ç®¡ç†çš„ç¾¤èŠå
                    if (await isRoomName(bot, msg)) return;
                }

                // è¯·æ±‚æœºå™¨äººèŠå¤©æ¥å£
                let res = await requestRobot(msg.text());
                // è¿”å›èŠå¤©æ¥å£å†…å®¹
                await msg.say(res)
            }
        } else {
            console.log("æ¶ˆæ¯ä¸æ˜¯æ–‡æœ¬ï¼");
            io.sendWechatMsg('æ”¶åˆ°éæ–‡æœ¬æ¶ˆæ¯');
        }
```

è¿™é‡Œæœ‰ä¸ªä»£ç å—

```javascript
let self = await msg.to();
```

å‚è€ƒåˆ«äººçš„ä»£ç ï¼Œè¿™ä¸ªåè®®ç‰ˆæœ¬è¿™é‡Œè·å–å‡ºæ¥çš„çš„æ˜¯nullï¼Œæ‰€ä»¥ç›´æ¥æ”¹æˆæ›¿æ¢æˆè‡ªå·±çš„nameï¼ˆconfigä¸­é…ç½®ï¼‰ï¼Œå¯èƒ½æ˜¯åè®®æˆ–ç‰ˆæœ¬ä¸ä¸€æ ·ï¼Œapiåšäº†è°ƒæ•´ï¼›è¿™é‡Œæˆ‘æ²¡ç»†æŸ¥å®˜æ–¹apiï¼Œæ¬¢è¿è¡¥å……ã€‚

**åŠ å…¥ç¾¤èŠç›‘å¬** è¿™é‡Œæœ‰ä¸ªä¸šåŠ¡ç‚¹ç®€å•æè¿°ä¸‹ï¼Œæ ¹æ®ç”¨æˆ·ç§èŠçš„çš„å†…å®¹ï¼Œåˆ¤æ–­æ˜¯å¦è§¦å‘å…³é”®è¯ï¼Œå¦‚æœè§¦å‘ç›´æ¥å‘é€å¯åŠ çš„ç¾¤ä¿¡æ¯ï¼›

```javascript
/**
 * @description å›å¤ä¿¡æ¯æ˜¯å…³é”®å­— â€œåŠ ç¾¤â€ å¤„ç†å‡½æ•°
 * @param {Object} msg æ¶ˆæ¯å¯¹è±¡
 * @return {Promise} true-æ˜¯ false-ä¸æ˜¯
 */
async function isAddRoom(msg) {
    // å…³é”®å­— åŠ ç¾¤ å¤„ç†
    if (msg.text() == "woè¦åŠ ç¾¤123") {
        let roomListName = Object.keys(roomList);
        let info = `${name}å½“å‰ç®¡ç†ç¾¤èŠæœ‰${roomListName.length}ä¸ªï¼Œå›å¤ç¾¤èŠåå³å¯åŠ å…¥å“¦\n\n`;
        roomListName.map(v => {
            info += "ã€" + v + "ã€‘" + "\n"
        });
        msg.say(info);
        return true
    }
    return false
}
```

**å›å¤ç¾¤åè¿›è¡Œç¾¤é‚€è¯·**

```javascript
/**
 * @description å›å¤ä¿¡æ¯æ˜¯æ‰€ç®¡ç†çš„ç¾¤èŠå å¤„ç†å‡½æ•°
 * @param {Object} bot å®ä¾‹å¯¹è±¡
 * @param {Object} msg æ¶ˆæ¯å¯¹è±¡
 * @return {Promise} true-æ˜¯ç¾¤èŠ false-ä¸æ˜¯ç¾¤èŠ
 */
async function isRoomName(bot, msg) {
    // å›å¤ä¿¡æ¯ä¸ºç®¡ç†çš„ç¾¤èŠå
    if (Object.keys(roomList).some(v => v == msg.text())) {
        // é€šè¿‡ç¾¤èŠidè·å–åˆ°è¯¥ç¾¤èŠå®ä¾‹
        const room = await bot.Room.find({ id: roomList[msg.text()] });

        // åˆ¤æ–­æ˜¯å¦åœ¨æˆ¿é—´ä¸­ åœ¨-æç¤ºå¹¶ç»“æŸ
        if (await room.has(msg.from())) {
            await msg.say("æ‚¨å·²ç»åœ¨æˆ¿é—´ä¸­äº†");
            return true
        }

        // å‘é€ç¾¤é‚€è¯·
        await room.add(msg.from())
        await msg.say("å·²å‘é€ç¾¤é‚€è¯·");
        return true
    }
    return false
}
```

### AIæœºå™¨äºº

è¯´åˆ°å¾®ä¿¡æœºå™¨äººï¼Œè‚¯å®šä¸èƒ½è„±ç¦»AIåªèƒ½å›å¤ï¼›è¿™é‡Œçš„ä¸šåŠ¡ç”¨åˆ°äº†è‡ªåŠ¨é™ªèŠå’Œå¤©æ°”æŸ¥è¯¢çš„åŠŸèƒ½ï¼Œåˆ†åˆ«ç”¨åˆ°äº†å¦‚ä¸‹apiï¼Œç›¸å…³å‚æ•°é…ç½®åœ¨configæ–‡ä»¶ï¼Œå¤§å®¶è‡ªè¡Œç”³è¯·api å‚æ•°è¿›è¡Œä¿®æ”¹

*   å…è´¹æœºå™¨äºº
    *   æ¥å£æ–‡æ¡£ï¼š[http://www.itpk.cn/](http://www.itpk.cn/)
    *   è¿™é‡Œè‡ªè¡Œæ³¨å†Œï¼Œè¿˜å¯ä»¥é…ç½®è‡ªå®šä¹‰å›å¤ï¼Œæ— ç­”æ¡ˆå›å¤ï¼Œè‡ªè¡Œè®­ç»ƒç­‰ç­‰
*   å…è´¹å¤©æ°”
    *   æ¥å£æ–‡æ¡£ï¼š[http://www.tianqiapi.com/](http://www.tianqiapi.com/%C2%A0)
    *   è¿™é‡Œå®˜æ–¹æ–‡æ¡£ç«Ÿç„¶ç»™äº†ä¸ªå…¬å¼€èƒ½ç”¨çš„appidå’Œappsecret...é¢ã€‚ã€‚ã€‚å¤§å®¶è‡ªè¡Œå‚è€ƒæ–‡æ¡£

è¿™é‡Œæ²¡ä»€ä¹ˆå¯ç»†è¯´ï¼Œä¸»è¦æ˜¯è°ƒç”¨ç¬¬ä¸‰æ–¹å°è£…çš„apiï¼Œè¿›è¡Œä¸€äº›å…³é”®è¯çš„è‡ªåŠ¨ç­”å¤ï¼›

æ¶‰åŠåˆ°apiçš„httpè¯·æ±‚ï¼Œæ‰€ä»¥éœ€è¦å¼•å…¥å¦‚ä¸‹ä¸¤ä¸ªæ¨¡å—

```bash
cnpm install --save request
cnpm install --save urlencode
```
è¿™é‡Œå°å°åæ§½ä¸‹å›¾çµï¼Œnå¹´ä½“éªŒè¿‡å›¾çµï¼Œè¿™å›æœ¬æ¥æƒ³ç”³è¯·å›¾çµçš„apiæµ‹è¯•ï¼Œç»“æœå…³æ³¨å®˜æ–¹å…¬ä¼—å·ç­‰æ¸ é“ä½“éªŒã€‚ã€‚ã€‚å¥½å§ï¼Œç«Ÿç„¶æ²¡æœ‰æœºå™¨äººåªèƒ½ç­”å¤ï¼Œé‚æ‰¾äº†å®¶å…è´¹çš„AIæœºå™¨äººï¼Œå¸Œæœ›å¤§å®¶åˆ«åæ§½ä¸æ™ºèƒ½~~~å“ˆå“ˆï¼Œæ¯•ç«Ÿitpkä¹Ÿéœ€è¦æ…¢æ…¢è¿›æ­¥å˜›
```javascript
/**
 * @description æœºå™¨äººè¯·æ±‚æ¥å£ å¤„ç†å‡½æ•°
 * @param {String} info å‘é€æ–‡å­—
 * @return {Promise} ç›¸åº”å†…å®¹
 */
function requestRobot(info) {
    info = info.trim();
    return new Promise((resolve, reject) => {
        let url = `http://i.itpk.cn/api.php?type=json&question=${urlencode(info)}&api_key=${itpkApiKey}&api_secret=${itpkApiSecret}`;
        if (info.endsWith("å¤©æ°”")) {
            info = info.replace("å¤©æ°”", "");
            url = `https://tianqiapi.com/api?version=v6&city=${urlencode(info)}&appid=${tianqiAppId}&appsecret=${tianqiAppSecret}`; //https://tianqiapi.com/api?version=v6&appid=94481879&appsecret=kYt0kSZ8   å®˜ç½‘demoç«Ÿç„¶ç»™äº†ä¸ªèƒ½ç”¨çš„appidå’Œappsecret
            request(url, (error, response, body) => {
                if (!error && response.statusCode == 200) {
                    if (body) {
                        if (!common.isJSON(body)) {
                            resolve('ä»Šå¤©çš„å¤©æ°”...555');
                        } else {
                            let res = JSON.parse(body);
                            if(res.errcode){
                                resolve('ä»Šå¤©çš„å¤©æ°”...555...555');
                            }else {
                                let send = "ã€æ—¥æœŸã€‘ï¼š" + res.date + "ï¼ˆ" + res.week + "ï¼‰\n" +
                                    "ã€æœ€è¿‘æ›´æ–°æ—¶é—´ã€‘ï¼š" + res.update_time + "\n" +
                                    "ã€å›½å®¶ã€‘ï¼š" + res.country + "ï¼ˆ" + res.countryEn + "ï¼‰\n" +
                                    "ã€åŸå¸‚ã€‘ï¼š" + res.city + "ï¼ˆ" + res.cityEn + "ï¼‰\n" +
                                    "ã€å¤©æ°”ã€‘ï¼š" + res.wea + "\n" +
                                    "ã€ä½“æ„Ÿæ¸©åº¦ã€‘ï¼š" + res.tem + "â„ƒ\n" +
                                    "ã€æ¸©åº¦èŒƒå›´ã€‘ï¼š" + res.tem2 + "â„ƒ~" + res.tem1 + "â„ƒ\n" +
                                    "ã€é£å‘ã€‘ï¼š" + res.win + "\n" +
                                    "ã€é£åŠ›ã€‘ï¼š" + res.win_speed + "\n" +
                                    "ã€æ¹¿åº¦ã€‘ï¼š" + res.humidity + "\n" +
                                    "ã€èƒ½è§åº¦ã€‘ï¼š" + res.visibility + "\n" +
                                    "ã€æ°”å‹ã€‘ï¼š" + res.pressure + "hPa\n" +
                                    "ã€ç©ºæ°”è´¨é‡ã€‘ï¼š" + res.air + "\n" +
                                    "ã€pm2.5ã€‘ï¼š" + res.air_pm25 + "\n" +
                                    "ã€æ¸©é¦¨æç¤ºã€‘ï¼š" + res.air_tips + "\n";
                                resolve(send);
                            }
                        }
                    }else {
                        resolve('å†ç­‰ç­‰å§ï¼Œä»Šå¤©çš„å¤©æ°”é¢„æŠ¥å¥½åƒ...è¿˜åœ¨è·¯ä¸Šå‘¢');
                    }
                }else {
                    resolve('ä»Šå¤©çš„å¤©æ°”é¢„æŠ¥å¥½åƒ...è¿˜åœ¨è·¯ä¸Šå‘¢');
                }
            });
        } else{
            request(url, (error, response, body) => {
                if (!error && response.statusCode == 200) {
                    if (body) {
                        if (body.startsWith('ï»¿')) {//æ­¤å¤„è¿”å›çš„jsonæ•°æ®æœ‰äº›é—®é¢˜ï¼Œé¢å¤–å¤„ç†
                            body = body.replace('ï»¿', '')
                        }

                        if (!common.isJSON(body)) {
                            resolve(body);
                        } else {
                            let res = JSON.parse(body);
                            let send;
                            if (res.type) {
                                send = 'ã€' + res.type + 'ã€‘\n \nç­¾å·ï¼š' + res.number1 + '\n \n';
                                switch (res.type) {
                                    case 'è§‚éŸ³çµç­¾':
                                        send = send + 'å¥½åï¼š' + res.haohua
                                            + '\n\n' + 'ç­¾è¯­ï¼š' + res.qianyu + '\n'
                                            + '\n' + 'è¯—æ„ï¼š' + res.shiyi + '\n'
                                            + '\n' + 'ç™½è¯ï¼š' + res.jieqian + '\n';
                                        break;
                                    case 'æœˆè€çµç­¾':
                                        send = send + 'å¥½åï¼š' + res.haohua
                                            + '\n\n' + 'è¯—æ„ï¼š' + res.shiyi + '\n'
                                            + '\n' + 'è§£ç­¾ï¼š' + res.jieqian + '\n'
                                            + '\n' + 'æ³¨é‡Šï¼š' + res.zhushi + '\n'
                                            + '\n' + 'ç™½è¯ï¼š' + res.baihua + '\n';
                                        break;
                                    case 'è´¢ç¥çˆ·çµç­¾':
                                        send = send + 'ç­¾è¯­ï¼š' + res.qianyu
                                            + '\n\n' + 'æ³¨é‡Šï¼š' + res.zhushi + '\n'
                                            + '\n' + 'è§£ç­¾ï¼š' + res.jieqian + '\n'
                                            + '\n' + 'è§£è¯´ï¼š' + res.jieshuo + '\n'
                                            + '\n' + 'ç»“æœï¼š' + res.jieguo + '\n'
                                            + '\n' + 'å©šå§»ï¼š' + res.hunyin + '\n'
                                            + '\n' + 'äº‹ä¸šï¼š' + res.shiye + '\n'
                                            + '\n' + 'åŠŸåï¼š' + res.gongming + '\n'
                                            + '\n' + 'å¤±ç‰©ï¼š' + res.shiwu + '\n'
                                            + '\n' + 'å‡ºå¤–ç§»å±…ï¼š' + res.cwyj + '\n'
                                            + '\n' + 'å…­ç”²ï¼š' + res.liujia + '\n'
                                            + '\n' + 'æ±‚è´¢ï¼š' + res.qiucai + '\n'
                                            + '\n' + 'äº¤æ˜“ï¼š' + res.jiaoyi + '\n'
                                            + '\n' + 'ç–¾ç—…ï¼š' + res.jibin + '\n'
                                            + '\n' + 'è¯‰è®¼ï¼š' + res.susong + '\n'
                                            + '\n' + 'è¿é€”ï¼š' + res.yuntu + '\n'
                                            + '\n' + 'æŸäº‹ï¼š' + res.moushi + '\n'
                                            + '\n' + 'åˆä¼™åšç”Ÿæ„ï¼š' + res.hhzsy + '\n';
                                        break;
                                    default:
                                }
                            } else if (res.title) {
                                send = 'ã€' + res.title + 'ã€‘\n \n \n' + res.content;
                            } else {
                                send = "å¤©å‘~~æˆ‘ç«Ÿç„¶...";
                            }
                            resolve(send);
                        }
                    } else {
                        resolve("æˆ‘..æˆ‘..æˆ‘ç”šè‡³ä¸çŸ¥é“ä½ åœ¨è¯´ä»€ä¹ˆ...")
                    }
                } else {
                    resolve("ä½ åœ¨è¯´ä»€ä¹ˆï¼Œæˆ‘è„‘å­æœ‰ç‚¹çŸ­è·¯è¯¶ï¼")
                }
            })
        }
    })
}
```
è¿™é‡Œæœ‰ä¸ªæ§½ç‚¹ï¼Œè°ƒç”¨æœºå™¨äººapiï¼Œè®¾ç½®è¿”å›çš„æ•°æ®æ˜¯jsonï¼Œä½†æ˜¯è¿”å›çš„bodyå­—ç¬¦ä¸²é‡Œå¼€é€šç«Ÿç„¶å¤šä¸ªä¸ª'-'ï¼Œå®Œäº†è¿˜åªèƒ½åœ¨ç¼–è¯‘å™¨çš„æ§åˆ¶å°èƒ½çœ‹åˆ°ï¼Œæ”¾åˆ°æµè§ˆå™¨å’Œåˆ«çš„ç¼–è¯‘å™¨æ˜¾ç¤ºä¸å‡ºæ¥ï¼Œåªèƒ½è¿›è¡Œç®€å•æ›¿æ¢å¤„ç†

```javascript
                        if (body.startsWith('ï»¿')) {//æ­¤å¤„è¿”å›çš„jsonæ•°æ®æœ‰äº›é—®é¢˜ï¼Œé¢å¤–å¤„ç†
                            body = body.replace('ï»¿', '')
                        }
```

### å›å½’SocketIo å‰ç«¯æ“ä½œ

è¿™é‡Œä¸ºäº†ä½“éªŒä¸‹æœºå™¨äººçš„ä»£å…¥æ„Ÿï¼Œåšäº†ä¸ªå‰ç«¯demoï¼ˆå¾ˆç®€é™‹ï¼Œè¿™é‡Œåˆ«åæ§½ã€‚ã€‚ã€‚å°±æ˜¯ä¸ºäº†å’Œsocketç»“åˆä¸€èµ·å®æ—¶çœ‹æ•ˆæœï¼›å¿½ç•¥å³ä¸Šè§’çš„çº¢x...è°ƒè¯•æ—¶ä¸­æ–­æœåŠ¡çš„åŸå› ...ï¼‰

![](https://img-blog.csdnimg.cn/20201210112918437.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3RvcGhpZ2htaQ==,size_16,color_FFFFFF,t_70)

**è¿™é‡Œç®€ä»‹ä¸‹nodejs express socketioçš„ä¸€äº›ä½¿ç”¨**

å‰ç«¯å¼•ç”¨socket.io.jsï¼Œä¸ºäº†æ–¹å¼å‰åç«¯socketç‰ˆæœ¬ä¸ä¸€è‡´å¸¦æ¥çš„é—®é¢˜ï¼Œå¼ºçƒˆå»ºè®®å¦‚ä¸‹å¼•ç”¨æ–¹å¼

```javascript
<script src="/socket.io/socket.io.js"></script>
```

ä¼šç›´æ¥è°ƒç”¨æ¥å£/socket.ioç›®å½•ä¸‹çš„jsæ–‡ä»¶ï¼Œå®é™…è°ƒç”¨åˆ°modulesç›®å½•ä¸‹çš„æ–‡ä»¶

![](https://img-blog.csdnimg.cn/20201210113825645.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3RvcGhpZ2htaQ==,size_16,color_FFFFFF,t_70)

å‰ç«¯å»ºç«‹socketè¿æ¥



```javascript
 var socket = io(url);
```

å»ºç«‹è¿æ¥åï¼Œç›‘å¬åä¸ºgetMsgçš„äº‹ä»¶

```javascript
        socket.on('getMsg', data => {
            console.log('æœåŠ¡ç«¯æ¶ˆæ¯ï¼š',  data);
            msg.innerHTML = `${data} <br/>`;
        })
```

å»ºç«‹è¿æ¥ï¼Œæƒ³æœåŠ¡ç«¯æ¨é€æ•°æ®ï¼ˆsocket.emit()ï¼‰ï¼Œå¯ä»¥æ˜¯Stringï¼Œå¯ä»¥æ˜¯jsonå¯¹è±¡

```javascript
        function sendWxmsg(){
            var friendNick = document.querySelector('#friendNick').value;
            var wechatContent = document.querySelector('#wechatContent').value;
            if(!friendNick || !wechatContent){
                alert("è¯·è¾“å…¥ä¿¡æ¯");
                return;
            }
            var wechatSend = {
                friendNick: friendNick,
                wechatContent: wechatContent
            };
            socket.emit('sendWechatText', wechatSend);
        }
```

### å›å½’SocketIo åç«¯æ“ä½œ

åˆå§‹åŒ–socketio

```javascript
io = require("socket.io")(server);
```

ç›‘å¬å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œè¿™é‡ŒsocketioçŸ¥è¯†ç‚¹å¾ˆå¤šï¼Œæ¯”å¦‚å¤šå®¢æˆ·ç«¯è¿æ¥ã€‚é€šè¿‡idå’ŒsessionåŒºåˆ†ç­‰ï¼Œå»ºè®®æ­å»ºå‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://socket.io/)ï¼Œå®˜æ–¹å¯¹socketioæ”¯æŒå¾ˆèµï¼Œjavaï¼Œpythonï¼Œnodejsç­‰ç­‰

```javascript
io.sockets.on('connection', function (socket) {});
```

äº‹ä»¶ç›‘å¬ï¼Œè¿™é‡Œä¸¾ä¾‹â€™sendâ€˜äº‹ä»¶ç›‘å¬ï¼Œå…·ä½“è§¦å‘å¦‚ä¸‹

*   è°ƒç”¨åˆå§‹åŒ–çš„ioè¿›è¡Œemit()æˆ–send()ï¼Œå¯å‘æ‰€æœ‰ç”¨æˆ·æ¨é€è¯¥æ¶ˆæ¯ï¼ˆé€‚ç”¨åœºæ™¯å‘æ‰€æœ‰å®¢æˆ·ç«¯æ¨é€ç´§æ€¥é€šçŸ¥ï¼‰
*   è°ƒç”¨è¯¥ç›‘å¬é€šé“ï¼Œå‘å½“å‰ç”¨æˆ·å›å¤æ¶ˆæ¯socket.emit()
*   è°ƒç”¨å½“å‰ç›‘å¬é€šé“ï¼Œå‘å‡ºè‡ªå·±å¤–çš„å…¶ä»–ç”¨æˆ·è¿›è¡Œå¹¿æ’­æ¨é€socket.broadcast.emit()
*   è°ƒç”¨åˆå§‹åŒ–çš„ioå‘æŸä¸ªå®¢æˆ·ç«¯è¿›è¡Œå•ç‹¬çš„æ¶ˆæ¯æ¨é€io.to(socketedId).emit()

```javascript
        //ç›‘å¬äº‹ä»¶send
        socket.on("send", data => {  // ç›‘å¬çš„é¢‘é“å¿…é¡»å’Œå®¢æˆ·ç«¯ç›‘å¬çš„é¢‘é“ç›¸åŒï¼Œç­‰å¾…æ¶ˆæ¯
            // io.emit("ç›‘å¬é¢‘é“", "å‘é€çš„ä¿¡æ¯");  // å‘æ‰€æœ‰å®¢æˆ·ç«¯å‘é€ä¿¡æ¯
            console.log('å®¢æˆ·ç«¯å‘é€çš„å†…å®¹ï¼š', data);
            io.emit('getMsg', 'æˆ‘æ˜¯è¿”å›çš„æ¶ˆæ¯... ...' + common.currentDateTime());//è§¦å‘æ‰€æœ‰ç”¨æˆ·
            // socket.emit('getMsg', 'æˆ‘æ˜¯è¿”å›çš„æ¶ˆæ¯... ...' + new Date().getTime());//è§¦å‘å½“å‰ç”¨æˆ·
            // socket.broadcast.emit('getMsg', 'æˆ‘æ˜¯è¿”å›çš„æ¶ˆæ¯... ...' + new Date().getTime());//è§¦å‘é™¤å»è¯¥ç”¨æˆ·ä»¥å¤–çš„ç”¨æˆ·
            // io.to(socketedId).emit('getMsg', 'æˆ‘æ˜¯è¿”å›çš„æ¶ˆæ¯... ...' + new Date().getTime());//è§¦å‘æŒ‡å®šç”¨æˆ·
        });
```

æ­¤demoçš„æ ¸å¿ƒä»£ç åŸºæœ¬å°±ä»‹ç»è¿™ä¹ˆå¤šäº†...

### å†™åœ¨æœ€å

*   configçš„å¾ˆå¤šé…ç½®åœ¨å®é™…ä¸šåŠ¡ä¸­åº”ä¸šåŠ¡åŒ–å¤„ç†ï¼Œæ¯”å¦‚dbåŒ–æ¥å—å®æ—¶æ“ä½œï¼›
*   å…³äºwechatyï¼Œæ ¹æ®ä¸ªäººçš„ä½“éªŒï¼Œé™¤äº†æ²¡æœ‰æœ‹å‹åœˆï¼Œè§†é¢‘å·ç›¸å…³çš„å†…å®¹æ“ä½œï¼Œå…¶ä»–çš„åŸºæœ¬æ»¡è¶³æœºå™¨äººã€ç§åŸŸç›¸å…³çš„æ“ä½œï¼Œæ”¯æŒå¤šè¯­è¨€ï¼Œæä¾›Javaï¼ŒGoï¼ŒPythonï¼ŒJavascriptï¼ŒC#ç­‰ä¸»æµè¯­è¨€çš„å…¼å®¹æ”¯æŒï¼Œæ ¹æ®å®˜æ–¹apiï¼Œä¸šåŠ¡å¯æ‰©å±•æ€§æå¼ºï¼›
*   å…³äºnodejsï¼Œç”±äºä½œè€…ä¹‹å‰å¹¶æ²¡æœ‰nodejså®æˆ˜å¼€å‘ç»éªŒï¼Œä¹Ÿæ˜¯åŸºäºè¿™ä¸ªdemoçœ‹äº†nodejsç›¸å…³æ–‡æ¡£ï¼Œå­¦ä¹ expressæ¡†æ¶åˆå­¦ï¼Œæä¾›ä¸äº†å¤ªå¤šè§£è¯»ã€‚ä¸è¿‡nodejsåŸºäºè„šæœ¬è¯­è¨€ï¼Œå­¦ä¹ èµ·æ¥è¿˜æ˜¯å¾ˆå¿«ï¼›
*   å…³äºsocketioï¼Œå’Œnodejsç»“åˆåœ¨ä¸€èµ·ï¼Œä½“éªŒnodejsçš„å¼‚æ­¥éé˜»å¡ï¼Œç®€ç›´è¦èµ·äº†é£ï¼›
*   ç¯å¢ƒ
    *   ç³»ç»Ÿï¼šwin7ã€centos7.6æˆåŠŸè¿è¡Œ
    *   nodejsç‰ˆæœ¬ï¼šwindowsä¸‹è°ƒè¯•ï¼šv12.16.2ï¼›centosï¼šv10.16.0ï¼›ï¼ˆwechatyå¯¹nodeç‰ˆæœ¬æœ‰è¦æ±‚ï¼Œä¸åŒåè®®ç‰ˆæœ¬æœ€ä½è¦æ±‚ä¸ä¸€è‡´ï¼Œå¤§å®¶è‡ªè¡Œå‚è€ƒå¼€æºè¯´æ˜å’Œå®˜æ–¹æ–‡æ¡£ï¼‰
*   ä»£ç 
    *   ä¸»è¦æ˜¯æŠ½ç©ºç å‡ºæ¥çš„ï¼Œæ²¡æœ‰å¤ªå¤šæ—¶é—´ä¼˜åŒ–
    *   æœ‰ä¸€äº›ä¸šåŠ¡ä»£ç å†™å¥½äº†ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æ¥å…¥ä½¿ç”¨ï¼Œæ¬¢è¿å¤§å®¶è¡¥å……
    *   åˆšå¼€å§‹æŸ¥æ‰¾å¾®ä¿¡åŠ©æ‰‹ç›¸å…³åŠŸèƒ½æ—¶åœ¨CSDNçœ‹åˆ°è¿™ç¯‡æ–‡ç« [ã€ŠWechaty|ä¸ä½¿ç”¨å¾®ä¿¡çš„webåè®®çš„æœºå™¨äººã€‹](https://blog.csdn.net/lx91216/article/details/106257248)ï¼Œå‹¾èµ·äº†æˆ‘å¯¹wechatyçš„å›å¿†å’Œæ¢ç´¢ï¼Œå› æ­¤è¿™ç¯‡æ–‡æ¡£å¾ˆå¤šå†…å®¹ä¸Šä¹Ÿæ˜¯å‚è€ƒäº†å®ƒï¼ˆæ—¶é—´å…³ç³»ç”šè‡³ç›´æ¥æ¬è¿ï¼Œå¸Œæœ›åŸæ–‡ä½œè€…åŸè°…å“ˆ...ï¼‰
    *   æºç ç›´é€šè½¦â†’[ç‚¹æˆ‘ã€Šwechaty-robot-liteã€‹](https://github.com/iTingle/wechaty-robot-lite)

åé¢æœ‰ç©ºï¼Œä¼šæŒç»­è¿­ä»£åŠŸèƒ½ï¼Œåç»­éœ€æ±‚æ‰©å±•

*   æ¨é€
    *   ä¾‹å¦‚æ¯æ—¥æ—©8ç‚¹ï¼Œæ‹‰å–å¤´æ¡`çƒ­é—¨æ–‡ç« `å‘é€è‡³ç¾¤èŠ
    *   å¯è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼Œå®šæ—¶ç»™è‡ªå·±/ç¾¤èŠå‘é€æ¶ˆæ¯
    *   å¥½å‹å¯å®šåˆ¶å¤©æ°”é¢„æŠ¥å®šæ—¶æ¨é€åŠŸèƒ½
*   æ¶ˆæ¯ç›‘å¬å‘é€
    *   åŒæ­¥å±•ç¤ºæ¨é€åª’ä½“æ¶ˆæ¯ç­‰
    *   æ”¯æŒå‘é€åŠ¨å›¾ï¼Œè¡¨æƒ…åŒ…ç­‰ä¿¡æ¯
    *   å¼€å¯æ–—å›¾æ¨¡å¼
*   ç¾¤èŠåŠŸèƒ½æ¶ˆæ¯ç®¡ç†
    *   ç›‘å¬ç¾¤èŠä¸­æ¶ˆæ¯ï¼Œæœ‰ä¸æ­£å½“è¨€è®ºæ—¶æˆ–ä¸æ–‡æ˜ç”¨è¯­å¯¹å…¶è­¦å‘Š
    *   æ¶‰zhengï¼Œæ¶‰huangç­‰è¨€è®ºæ¸…é™¤å‡ºç¾¤
*   ç¾¤èŠæ¸¸æˆ
*   åå°ç®¡ç†ç³»ç»Ÿ(å¯è§†åŒ–é…ç½®åŠç¾¤èŠæ•°æ®ç»Ÿè®¡)
    *   ä¸°å¯ŒèŠå¤©åŠŸèƒ½ï¼Œæä¾›åª’ä½“æ¶ˆæ¯å‘é€ï¼Œèµ„æºåº“å†…å®¹å‘é€
    *   ç»Ÿè®¡ç¾¤èŠæ´»è·ƒåº¦ï¼Œå…³é”®è¯é€šçŸ¥ç»Ÿè®¡åŠŸèƒ½

### PSï¼š

è¿™ç¯‡æ–‡æ¡£è¯´çš„æœ€å¤šçš„åº”è¯¥æ˜¯â€å®˜æ–¹æ–‡æ¡£â€œå››ä¸ªå­—äº†å§ï¼Œè¿™é‡Œå†ç‚¹ä¸€ä¸‹ï¼Œ`è®¤çœŸçœ‹æ–‡æ¡£ï¼ï¼ï¼`

### å‚è€ƒæ–‡æ¡£

*   [Wechatyå®˜æ–¹API](https://wechaty.js.org/docs/api/)
*   [Wechatyå®˜æ–¹æ–‡æ¡£](https://wechaty.github.io/wechaty/)
*   [Wechatyå®˜æ–¹ç¤ºä¾‹](https://github.com/juzibot/donut-tester#example)
*   [socketio](https://socket.io/)
*   [nodejs](http://nodejs.cn/)
*   [expressæ¡†æ¶](https://www.expressjs.com.cn/)

### æ•ˆæœæˆªå›¾

![](https://img-blog.csdnimg.cn/20201210122920648.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3RvcGhpZ2htaQ==,size_16,color_FFFFFF,t_70)

![](https://img-blog.csdnimg.cn/20201210122949780.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3RvcGhpZ2htaQ==,size_16,color_FFFFFF,t_70)

![](https://img-blog.csdnimg.cn/20201210123153241.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3RvcGhpZ2htaQ==,size_16,color_FFFFFF,t_70)

å¾…å®Œç»“